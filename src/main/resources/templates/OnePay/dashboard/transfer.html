<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Transfer</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>

<div class="container mt-5">
    <h2>Wallet Transfer</h2>
    <form id="transfer-form">
        <!-- Sender Wallet ID -->
        <div class="form-group">
            <label for="senderWalletId">Sender Wallet ID:</label>
            <input type="number" class="form-control" id="senderWalletId" placeholder="Enter Sender Wallet ID" required>
            <div class="invalid-feedback">Sender Wallet ID is required.</div>
        </div>

        <!-- Receiver Wallet ID -->
        <div class="form-group">
            <label for="receiverWalletId">Receiver Wallet ID:</label>
            <input type="number" class="form-control" id="receiverWalletId" placeholder="Enter Receiver Wallet ID" required>
            <div class="invalid-feedback">Receiver Wallet ID is required.</div>
        </div>

        <!-- Amount -->
        <div class="form-group">
            <label for="amount">Amount to Transfer:</label>
            <input type="number" class="form-control" id="amount" step="0.01" placeholder="Enter Amount" required>
            <div class="invalid-feedback">Amount is required and must be greater than 0.</div>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="btn btn-primary">Transfer Now</button>
    </form>

    <div id="resultMessage" class="mt-3"></div>
</div>

<script>
    document.getElementById('transfer-form').addEventListener('submit', function (event) {
        event.preventDefault();  // Prevent default form submission

        // Get input values
        const senderWalletId = document.getElementById('senderWalletId').value;
        const receiverWalletId = document.getElementById('receiverWalletId').value;
        const amount = document.getElementById('amount').value;

        let isValid = true;

        // Validate Sender Wallet ID
        if (!senderWalletId || isNaN(senderWalletId) || senderWalletId <= 0) {
            document.getElementById('senderWalletId').classList.add('is-invalid');
            isValid = false;
        } else {
            document.getElementById('senderWalletId').classList.remove('is-invalid');
        }

        // Validate Receiver Wallet ID
        if (!receiverWalletId || isNaN(receiverWalletId) || receiverWalletId <= 0) {
            document.getElementById('receiverWalletId').classList.add('is-invalid');
            isValid = false;
        } else {
            document.getElementById('receiverWalletId').classList.remove('is-invalid');
        }

        // Validate Amount
        if (!amount || isNaN(amount) || amount <= 0) {
            document.getElementById('amount').classList.add('is-invalid');
            isValid = false;
        } else {
            document.getElementById('amount').classList.remove('is-invalid');
        }

        // If form is not valid, stop submission
        if (!isValid) {
            return;
        }

        // Generate current timestamp for transfer_date
        const transferDate = new Date().toISOString();

        // Generate a unique transaction ID (UUID or similar)
        const transactionId = 'trans-' + Math.random().toString(36).substr(2, 9);

        // Create transfer payload to match the SQL format
        const transferPayload = {
            senderWalletId: parseInt(senderWalletId),
            receiverWalletId: parseInt(receiverWalletId),
            amount: parseFloat(amount),
            transferDate: transferDate,
            status: 'pending',  // Default status as 'pending'
            transactionId: transactionId
        };

        // Perform the transfer using fetch API
        fetch('/api/wallet-transfers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(transferPayload)
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('resultMessage').innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                } else {
                    document.getElementById('resultMessage').innerHTML = `<div class="alert alert-danger">Transfer failed: ${data.message}</div>`;
                }
            })
            .catch(error => {
                console.error('Error during transfer:', error);
                document.getElementById('resultMessage').innerHTML = `<div class="alert alert-danger">An error occurred. Please try again.</div>`;
            });
    });
</script>

</body>
</html>
